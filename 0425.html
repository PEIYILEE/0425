<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arduino æ§åˆ¶æ–œç·šï¼ˆå¹³æ»‘ç‰ˆï¼‰</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: black;
        }

        #connectButton {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            font-size: 18px;
            z-index: 10;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

            #connectButton:hover {
                background: #45a049;
            }
    </style>
</head>
<body>
    <button id="connectButton">ğŸ”Œ é€£æ¥ Arduino</button>
    <canvas id="slopeCanvas"></canvas>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const canvas = document.getElementById('slopeCanvas');
            const ctx = canvas.getContext('2d');
            const connectButton = document.getElementById('connectButton');
            resizeCanvas();

            let x = 0;
            let y_red = canvas.height / 4;
            let y_green = canvas.height / 2;
            let y_blue = canvas.height * 3 / 4;

            let targetSlope = 0;    // ç›®æ¨™æ–œç‡
            let currentSlope = 0;   // ç›®å‰æ–œç‡ï¼ˆæœƒæ…¢æ…¢è¿½ä¸Šç›®æ¨™ï¼Œå¹³æ»‘éæ¸¡ï¼‰
            let val0 = 0;           // ç›®å‰çš„é›»é˜»å€¼

            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }

            window.addEventListener('resize', resizeCanvas);

            function mapResistanceToSlope(resistance) {
                const center = 500; // ä½ çš„åŸºæº–é»
                const diff = resistance - center;
                const baseSlope = Math.abs(diff) / 300; // èª¿æ•´é€™å€‹æ•¸å­—æ§åˆ¶æ•æ„Ÿåº¦
                if (diff > 0) {
                    return baseSlope;    // å·¦ä¸‹åˆ°å³ä¸Š
                } else if (diff < 0) {
                    return -baseSlope;   // å³ä¸‹åˆ°å·¦ä¸Š
                } else {
                    return 0;            // æ­£æ°´å¹³
                }
            }

            function updateSlope(v0) {
                val0 = v0;
                targetSlope = mapResistanceToSlope(val0);
            }

            function draw() {
                x += 1;

                // å¹³æ»‘éæ¸¡ï¼šè®“ currentSlope æ…¢æ…¢è¿½å‘ targetSlope
                currentSlope += (targetSlope - currentSlope) * 0.05;

                y_red += currentSlope;
                y_green = canvas.height / 2;
                y_blue += currentSlope;

                // ç•«ç´…ç·š
                ctx.beginPath();
                ctx.strokeStyle = 'red';
                ctx.moveTo(x - 1, y_red - currentSlope);
                ctx.lineTo(x, y_red);
                ctx.stroke();

                // ç•«ç¶ ç·šï¼ˆå›ºå®šæ°´å¹³ï¼‰
                ctx.beginPath();
                ctx.strokeStyle = 'green';
                ctx.moveTo(x - 1, y_green);
                ctx.lineTo(x, y_green);
                ctx.stroke();

                // ç•«è—ç·š
                ctx.beginPath();
                ctx.strokeStyle = 'blue';
                ctx.moveTo(x - 1, y_blue - currentSlope);
                ctx.lineTo(x, y_blue);
                ctx.stroke();

                // æ›´æ–°å³ä¸Šè§’è³‡è¨Š
                ctx.fillStyle = 'black';
                ctx.fillRect(canvas.width - 220, 0, 220, 50);

                ctx.fillStyle = 'white';
                ctx.font = '20px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(`val0: ${val0}`, canvas.width - 20, 40);

                // åˆ°é”æœ€å³é‚Šæ™‚é‡ç½®
                if (x > canvas.width) {
                    x = 0;
                    y_red = canvas.height / 4;
                    y_green = canvas.height / 2;
                    y_blue = canvas.height * 3 / 4;

                    ctx.fillStyle = 'black';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }

                requestAnimationFrame(draw);
            }

            draw();

            connectButton.addEventListener('click', async () => {
                try {
                    const port = await navigator.serial.requestPort();
                    await port.open({ baudRate: 9600 });
                    const reader = port.readable.getReader();
                    console.log('å·²é€£æ¥ Arduinoï¼Œé–‹å§‹æ¥æ”¶æ•¸æ“š');

                    async function readLoop() {
                        while (true) {
                            const { value, done } = await reader.read();
                            if (done) {
                                reader.releaseLock();
                                break;
                            }
                            const text = new TextDecoder().decode(value);
                            const cleanText = text.trim();
                            if (cleanText) {
                                const v0 = Number(cleanText);
                                if (!isNaN(v0)) {
                                    updateSlope(v0);
                                }
                            }
                        }
                    }
                    readLoop();
                } catch (error) {
                    console.error('é€£æ¥å¤±æ•—', error);
                    alert('é€£æ¥å¤±æ•—ï¼Œè«‹ç¢ºèª Arduino æœ‰æ¥ä¸Š');
                }
            });

        });
    </script>
</body>
</html>